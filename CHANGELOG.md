# 更新日志

## 2021

### 01-21 v2.21.8

- 修复配置读取问题

### 01-21 v2.21.7

- 修复配置热重载不能重载 `saucenaoApiKey` 的问题
- saucenao 搜索失败可自动使用 ascii2d
- 移除旧的 npm script `pm2*`
- 配置项变更
  - A `bot.useAscii2dWhenFailed`

## 2020

### 12-31 v2.21.6

- 不再对红链进行短链接处理 ([#124](../../issues/124))
- sqlite3 依赖升级至 5.0.0 使 node 14 能够下载 prebuilt

### 12-17 v2.21.5

- 忽略回复机器人消息的消息

### 12-15 v2.21.4

- 搜图增加 `--all` 参数，使得设置了其它默认搜图库时可以靠参数使用全库搜索
- 修复输出的更新日志可能过时的问题
- 会输出大于本地版本的所有更新日志
- 配置项变更
  - M `bot.checkUpdate` 单位变更为小时

### 12-15 v2.21.3

- 修复检查更新间隔不正确的问题

### 12-15 v2.21.2

- 新增忽略QQ官方机器人的能力，防止共用时意外对线
- 配置项变更
  - A `bot.ignoreOfficialBot`

### 12-14 v2.21.1

- 修复群消息不响应的问题 ([#116](../../issues/116))

### 12-13 v2.21.0

- 调整检查更新的时机
- 群内支持通过回复来使用搜图等与图片相关的功能 (go-cqhttp ≥ v0.9.32)
- 新增获取群文件下载直链的功能 (go-cqhttp ≥ v0.9.32)

### 12-07 v2.20.5

- 修复部分情况下检查更新出错的问题
- 完善 setu 反和谐失败的提示

### 12-06 v2.20.4

- 修复极端情况下可能导致定时提醒出现较大误差的问题

### 12-03 v2.20.3

- 修复因 setu 原图过大而无法反和谐的问题

### 12-03 v2.20.2

- 修复检查更新功能
- 修复在搜图模式下指定图库为 anime 时不会用 whatanime 搜索的问题

### 11-23 v2.20.1

- 修复明日方舟公招计算器不识别资深和高资的问题（需要私聊 `--update-akhr` 更新数据）

### 11-23 v2.20.0

- 配置文件变更为 jsonc 格式以支持注释（用户无需进行额外操作）

### 11-08 v2.19.1

- 修复发图片时多一个 `]` 的问题

### 11-08 v2.19.0

- 支持 QQ OCR（需要 go-cqhttp ≥ v0.9.26）
- 新增将 setu 逆时针旋转90°的反和谐方式（`bot.setu.antiShielding = 2`）
- setu 支持以闪照形式发送
- 定时检查更新
- 明日方舟公招数据源变更为 [arkntools/arknights-toolbox](https://github.com/arkntools/arknights-toolbox)
- 配置项变更
  - A `bot.checkUpdate`
  - M `bot.setu.antiShielding`：类型由 `Boolean` 更改为 `Number`，会自动迁移
  - M `bot.setu.deleteTime` `bot.setu.whiteDeleteTime`：`-1` 为发送闪照
  - M `bot.ocr.use` `bot.akhr.ocr`：支持 `qq`

### 09-13 v2.18.1

- 修复消息群发失效 ([#101](../../issues/101))

### 09-12 v2.18.0

- 增加[语言库](../../wiki/%E9%99%84%E5%8A%A0%E5%8A%9F%E8%83%BD#%E8%AF%AD%E8%A8%80%E5%BA%93%E8%87%AA%E5%8A%A8%E5%9B%9E%E5%A4%8D)功能（自动回复）
- 配置项变更
  - A `bot.corpus`

### 09-11 v2.17.1

- 支持`[CQ:json]` ([#100](../../issues/100))

### 09-05 v2.17.0

- 支持[配置热重载](../../wiki/%E5%A6%82%E4%BD%95%E9%A3%9F%E7%94%A8#%E9%85%8D%E7%BD%AE%E7%83%AD%E9%87%8D%E8%BD%BD)
- 改进定时提醒的逻辑
- 修复机器人手动入群后没有文字反馈的问题

### 09-05 v2.16.1

- 修复 JSON 转义问题导致的哔哩哔哩小程序识别错误 ([#96](../../issues/96))
- 改进 nHentai 搜索

### 08-27 v2.16.0

- 增加搜图结果发送缩略图相关的详细设置 ([#90](../../issues/92))
- 配置项变更
  - M `bot.saucenaoHideImgWhenLowAcc` -> `bot.hideImgWhenLowAcc`：会自动迁移，无需手动更改
  - A `bot.hideImg`
  - A `bot.hideImgWhenWhatanimeR18`

### 08-17 v2.15.4

- 修复定时提醒 interval 超出 32 位有符号整数导致的刷屏问题 ([#90](../../issues/90))

### 08-16 v2.15.3

- 修复反 Bilibili 小程序会响应动态的小程序分享的问题 ([#89](../../issues/89))

### 08-15 v2.15.2

- 修复反 Bilibili 小程序的防刷屏逻辑问题 ([#87](../../issues/87))
- 搜图参数及图库关键字中的`book`修改为`doujin`，但`book`依然可用

### 08-14 v2.15.1

- 为`config.json`增加`$schema`
- 恢复群发消息功能 ([#86](../../issues/86))

### 08-13 v2.15.0

- 完全恢复转义，需使用 go-cqhttp v0.9.18 及以上版本
- 在群内发送搜图结果将会采用回复的形式 ([#84](../../issues/84))
- 启动时会检查配置文件是否存在以及 JSON 合法性
- 可独立开关私聊和群组消息的监听
- 配置项变更
  - M `picfinder` -> `bot`，会自动迁移，无需手动更改
  - A `bot.enablePM`
  - A `bot.enableGM`

### 08-10 v2.14.3

- 恢复部分转义，需使用 go-cqhttp v0.9.16 及以上版本

### 08-07 v2.14.2

- 因 go-cqhttp 尚未支持转义 [Mrs4s/go-cqhttp#9](https://github.com/Mrs4s/go-cqhttp/issues/9)，因此暂时禁用了消息的转义，待其修复后需要更新 go-cqhttp 和本项目

### 08-07 v2.14.1

- 之前忘记删除签到（点赞）相关功能代码了

### 08-05 v2.14.0 **R.I.P. CoolQ**

- 目前决定专注于适配 [go-cqhttp](https://github.com/Mrs4s/go-cqhttp)，其余方案暂不考虑
  - mirai-native + cq-http 经测试仍然有很多问题且部署麻烦，因此放弃
  - 如果发现某些功能运作不正常或与原先表现不一致，可提 issue 向我反馈
- 请参考 wiki 进行迁移或部署，另外，配置文件结构有些许变动（主要是 node-cq-websocket 部分），请注意修改
- mirai 不支持点赞，自动点赞功能及相关配置项已被删除

### 07-30 v2.13.5

- 自定义每日资料卡点赞名单
- 配置项变更
  - A `bot.dailyLike`

### 07-24 v2.13.4

- 反 Bilibili 小程序功能在 3 分钟内将不会重复解析同一视频链接，以防刷屏

### 07-06 v2.13.3

- 增加 setu API 超额时的自定义回复
- 配置项变更
  - A `bot.replys.setuQuotaExceeded`

### 07-02 v2.13.2

- 修复定时提醒的逻辑错误

### 06-27 v2.13.1

- 修复搜图缓存没有正常运作的问题

### 06-27 v2.13.0

- 修复提醒功能失效问题 ([#75](../../issues/75))
- 弃用 mysql，仅使用 sqlite，配置项转移
- 配置项变更
  - D `mysql`
  - A `bot.cache`
  - `mysql.enable` -> `bot.cache.enable`
  - `mysql.expire` -> `bot.cache.expire`

### 5-10 v2.12.6

- 修复一个 bug

### 5-10 v2.12.5

- 修复方舟公招数据更新问题

### 5-05 v2.12.4

- 增加私聊回复群聊中搜图结果的功能 ([#60](../../issues/60))
- 配置项变更
  - A `bot.pmSearchResult`

### 5-01 v2.12.3

- 反哔哩哔哩小程序不支持番剧链接，将尽可能忽略番剧链接 ([#59](../../issues/59))

### 4-29 v2.12.2

- 更新方舟公招数据来源

### 4-29 v2.12.1

- 修正 debug 逻辑 ([#58](../../issues/58))

### 4-27 v2.12.0

- 增加“反哔哩哔哩小程序”功能，鼓励发链接，发链接时会自动获取视频信息并发送，详情看 wiki 配置说明及附加功能
- 配置项变更
  - A `bot.antiBiliMiniApp`

### 4-24 v2.11.14

- 更改公开招募计算器触发词，不再需要`--akhr`，改为包含`akhr`或`公招`一词即可

### 4-11 v2.11.13

- 修复 danbooru 获取原图来源问题

### 3-18 v2.11.12

- 修复 whatanime 错误 ([#54](../../issues/54))
- 改进错误输出

### 3-18 v2.11.11

- 修复反和谐生成图片过大问题 ([#53](../../issues/53))

### 3-17 v2.11.10

- 修复定时提醒功能判断分钟级间隔有误的问题

### 3-14 v2.11.9

- 更换 akhr 数据地址 ([#49](../../issues/49))
- 增加 whatanime 的 token 设置
- 配置项变更
  - A `whatanimeToken`

### 3-9 v2.11.8

- 增加 setu 的 apikey 设置
- 配置项变更
  - A `bot.setu.apikey`

### 2-21 v2.11.7

- 修复通用处理完成后未停止事件传播的问题 ([#36](../../issues/36))

### 2-18 v2.11.6

- WhatAnime 使用官方提供的 API

### 2-03 v2.11.5

- 增加 SauceNao 低相似度值自定义配置
- 增加“SauceNao 结果相似度过低时结果缩略图的替代文字”的配置
- 配置项变更
  - A `bot.saucenaoLowAcc`
  - A `bot.replys.lowAccImgPlaceholder`

### 2-01 v2.11.4

- 增加“SauceNao 结果相似度过低时隐藏结果缩略图”的配置
- 配置项变更
  - A `bot.saucenaoHideImgWhenLowAcc`

### 1-29 v2.11.3

- 增加对`http://www.pixiv.net/(artworks|users)/[0-9]+`链接的短缩

### 1-21 v2.11.2

- 增加配置项用于控制是否在 saucenao 结果低相似度或配额耗尽时使用 ascii2d
- 配置项变更
  - A `bot.useAscii2dWhenQuotaExcess`
  - A `bot.useAscii2dWhenLowAcc`

### 1-15 v2.11.1

- 因酷Q不支持本地发送大于 4M 的图片，因此开启反和谐后如果没有开启 size1200 并且原图大小超过 3M，将会自动使用 size1200 ([#40](../../issues/40))

## 2019

### 12-18 v2.11.0

- 当 ascii2d 失败时返回错误信息
- 支持自定义 ascii2d 的域名
- saucenao, whatanime, ascii2d 的自定义域名支持带上协议，即支持以下写法
  - `example.com`：将会使用`http://example.com`；特殊地，上面三者的官方域名将会使用 https
  - `http://example.com`或`https://example.com`
- 支持[群发消息](../../wiki/%E5%A6%82%E4%BD%95%E9%A3%9F%E7%94%A8#%E7%BE%A4%E5%8F%91%E6%B6%88%E6%81%AF)
- 配置项变更
  - A `ascii2dHost`

### 12-09 v2.10.1

- 增大 setu 反和谐力度
- 支持获取 yande.re 结果的原出处
- 增加`--help`,`--about`,`--version`命令

### 12-02 v2.10.0

- setu 反和谐
- 配置项变更
  - A `bot.setu.antiShielding`

### 11-05 v2.9.5

- 在 ascii2d 搜索失败时返回失败提示语 #31

### 10-29 v2.9.4

- 使用 named-regexp-groups 模块以解决某些 node 版本莫名其妙无法使用命名正则表达式捕获组的问题
- 搜图错误时的回复增加了 saucenao host index

### 10-25 v2.9.3

- 支持发送 master1200 大小的 setu 以改善小水管或国内机器发图速度
- 配置项变更
  - A `bot.setu.size1200`

### 10-22 v2.9.2

- 修复 admin 搜图时的记录问题
- 修复 npm 脚本错误
- 改善 setu 正则表达式

### 10-15 v2.9.1

- 增加 pm2 配置文件，目前可直接使用`pm2 start|stop|restart|logs`等命令控制
- 增加按关键词发 setu 以及 r18 setu 功能，若从旧版本升级，请参考 wiki 中 setu 功能说明进行设置
- 配置项变更（重要）
  - A `bot.setu.r18OnlyInWhite`
  - M `bot.regs.setu`

### 08-21 v2.8.0

- 增加对提醒功能最小提醒间隔的限制，新增配置项支持限制使用场景
- 提醒功能的 cron 表达式变更为使用分号分隔
- 增加设置项`bot.proxy`，支持使用 http 或 socks 代理

### 08-21 v2.7.2

- 增加连接错误的输出
- 对红名链接做 is.gd 短链接处理并使用防红名跳转

### 08-16 v2.7.1

- 对红名链接做 t.cn 短链接处理（在国外服务器上访问 API 有可能会有连接重置问题，已弃用）

### 08-16 v2.7.0

- 增加配置项`bot.saucenaoDefaultDB`，用于设置默认 saucenao DB
- 增加定时提醒功能，详见 README

### 08-01 v2.6.0

- 增加 SQLite 支持，增加设置项`mysql.sqlite`
- saucenao 配额耗尽后自动使用 ascii2d

### 07-07 v2.5.4

- 【腾讯 OCR】支持轮换 API 使用以变相提升免费额度
- 对【明日方舟公开招募计算器】的 OCR 增加了纠错
- 增加配置项
  - `bot.searchModeTimeout`
  - `bot.ocr.tencent.useApi`

### 07-02 v2.5.3

- 增加了【腾讯 OCR】的支持
- 增加了`bot.setu.pximgServerPort`和`bot.setu.usePximgAddr`设置项，以方便使用 Docker 版酷Q的用户

### 05-25 v2.5.2

- 增加了【百度 OCR】的支持，以提升对明日方舟公开招募词条的识别率和准确率
- **`ocr`部分的配置格式有改动，请参照新的`config.default.json`进行修改**
- 对【明日方舟公开招募计算器】进行了许多改进

### 05-24 v2.5.1

- `--add-group=`加群指令现在可以直接同意发送指令之前接收到的入群邀请了
- 对【明日方舟公开招募计算器】进行了许多改进

### 05-21 v2.5.0

- 加入【明日方舟公开招募计算器】功能，测试中

### 04-26 v2.4.0

- 增加对 ascii2d 的支持
- pixiv 结果会同时输出画师主页
- 对 danbooru 等标有原始来源的站点会自动获取原始链接
- 增加 OCR 功能
- 移除“文字模式”`textMode`设定，废弃使用分享形式发送结果的方式
- 对 WhatAnime 相关配置进行了调整，可参考新的`config.default.json`，但仍然兼容以前的配置方式

### 01-04 v2.3.2

- 增加检测问题回答加好友的机制

## 2018

### 12-05 v2.3.0

- 未在`config.json`中指定的配置将会使用`config.default.json`中的默认值
- 对 setu 功能进行了机制完善
- 稳定性提升

### 11-27 v2.2.1

一大堆改动，忘了写懒得补了 \_(:3」∠)\_

### 08-16 v2.1.0

- （暴力地）修复了当图片标题含有 emoji 时分享不正常的 bug
- 根据 @fuochai 的建议，将P站链接替换成短链接

### 07-16 v2.0.1

- 增加搜图模式下的搜图范围指定功能

### 06-06

- 修复了某些本子因含有特定符号而无法在 nhentai 搜索到（实际上 nhentai 有这本子

### 06-05

- 为了减少 API 的使用次数以及加快搜图速度，增加搜图缓存功能，某张图片（MD5 作为凭证）的搜索结果会被缓存指定时间，但可以用`--purge`参数无视缓存强制更新搜图结果
- 增加搜图次数限制功能

### 05-30

- 增加`--book`参数，用于指定搜索本子

### 05-19

- 增加`--danbooru`参数，用于指定搜索图库

### 03-22

- 改进了搜索结果表示
- 弃用`-s`和`-c`参数，使搜图监听模式的触发更人性化
- 使用`--anime`参数可以利用 whatanime 搜番（测试中，尚未作为正式功能，还有很大改进余地）

### 02-24

- 改进`-s`搜图的逻辑，现在可以进入搜图模式之后一直发图片进行查询，直到用`-c`参数退出

### 02-16

- 增加`-s`参数搜图模式，以应对类似“因转发图片至群里而无法@机器人”导致搜图过程复杂的问题

### 02-12

- 支持识别本子的搜索结果

### 01-23

- 搜图支持批量了

### 01-22

- 重写搜图结果识别方法与逻辑
- 修复了当图片不为消息最后一个内容时会导致无法搜图的 bug

### 01-21

初 版
